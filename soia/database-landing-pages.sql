-- ========================================
-- TABELA DE LANDING PAGES / FORMUL√ÅRIOS DE CAPTURA
-- ========================================

-- Criar tabela de landing pages
CREATE TABLE IF NOT EXISTS public.landing_pages (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  
  -- Identifica√ß√£o
  slug TEXT NOT NULL UNIQUE,
  titulo TEXT NOT NULL,
  descricao TEXT,
  
  -- Configura√ß√£o dos campos
  campos_habilitados JSONB NOT NULL DEFAULT '["nome", "telefone", "email"]',
  
  -- Mensagem WhatsApp
  mensagem_whatsapp TEXT NOT NULL,
  
  -- Personaliza√ß√£o visual
  cor_primaria TEXT DEFAULT '#3B82F6',
  imagem_url TEXT,
  
  -- Status e m√©tricas
  ativo BOOLEAN NOT NULL DEFAULT true,
  total_acessos INTEGER NOT NULL DEFAULT 0,
  total_conversoes INTEGER NOT NULL DEFAULT 0,
  
  -- Rastreamento
  utm_source TEXT,
  utm_campaign TEXT
);

-- Criar √≠ndices
CREATE INDEX IF NOT EXISTS idx_landing_pages_slug ON public.landing_pages(slug);
CREATE INDEX IF NOT EXISTS idx_landing_pages_ativo ON public.landing_pages(ativo);

-- Habilitar RLS
ALTER TABLE public.landing_pages ENABLE ROW LEVEL SECURITY;

-- Pol√≠ticas RLS
DROP POLICY IF EXISTS "Permitir leitura de landing pages ativas" ON public.landing_pages;
CREATE POLICY "Permitir leitura de landing pages ativas" 
  ON public.landing_pages
  FOR SELECT
  USING (ativo = true);

DROP POLICY IF EXISTS "Permitir inser√ß√£o de landing pages" ON public.landing_pages;
CREATE POLICY "Permitir inser√ß√£o de landing pages" 
  ON public.landing_pages
  FOR INSERT
  WITH CHECK (true);

DROP POLICY IF EXISTS "Permitir atualiza√ß√£o de landing pages" ON public.landing_pages;
CREATE POLICY "Permitir atualiza√ß√£o de landing pages" 
  ON public.landing_pages
  FOR UPDATE
  USING (true);

DROP POLICY IF EXISTS "Permitir exclus√£o de landing pages" ON public.landing_pages;
CREATE POLICY "Permitir exclus√£o de landing pages" 
  ON public.landing_pages
  FOR DELETE
  USING (true);

-- Tabela de convers√µes (rastreamento)
CREATE TABLE IF NOT EXISTS public.landing_page_conversoes (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
  
  landing_page_id BIGINT NOT NULL REFERENCES public.landing_pages(id) ON DELETE CASCADE,
  cliente_id BIGINT REFERENCES public.clientes(id) ON DELETE SET NULL,
  
  -- Dados capturados
  dados_capturados JSONB NOT NULL,
  
  -- Informa√ß√µes de rastreamento
  ip_address TEXT,
  user_agent TEXT,
  utm_source TEXT,
  utm_campaign TEXT,
  
  -- Status do envio
  whatsapp_enviado BOOLEAN DEFAULT false,
  whatsapp_erro TEXT
);

-- Criar √≠ndices
CREATE INDEX IF NOT EXISTS idx_conversoes_landing_page ON public.landing_page_conversoes(landing_page_id);
CREATE INDEX IF NOT EXISTS idx_conversoes_cliente ON public.landing_page_conversoes(cliente_id);
CREATE INDEX IF NOT EXISTS idx_conversoes_data ON public.landing_page_conversoes(created_at);

-- Habilitar RLS
ALTER TABLE public.landing_page_conversoes ENABLE ROW LEVEL SECURITY;

-- Pol√≠ticas RLS
DROP POLICY IF EXISTS "Permitir leitura de convers√µes" ON public.landing_page_conversoes;
CREATE POLICY "Permitir leitura de convers√µes" 
  ON public.landing_page_conversoes
  FOR SELECT
  USING (true);

DROP POLICY IF EXISTS "Permitir inser√ß√£o de convers√µes" ON public.landing_page_conversoes;
CREATE POLICY "Permitir inser√ß√£o de convers√µes" 
  ON public.landing_page_conversoes
  FOR INSERT
  WITH CHECK (true);

-- Fun√ß√£o para gerar slug √∫nico
CREATE OR REPLACE FUNCTION gerar_slug_unico()
RETURNS TEXT AS $$
DECLARE
  novo_slug TEXT;
  existe BOOLEAN;
BEGIN
  LOOP
    -- Gera slug aleat√≥rio de 8 caracteres
    novo_slug := LOWER(substring(md5(random()::text) from 1 for 8));
    
    -- Verifica se j√° existe
    SELECT EXISTS(SELECT 1 FROM public.landing_pages WHERE slug = novo_slug) INTO existe;
    
    -- Se n√£o existe, retorna
    IF NOT existe THEN
      RETURN novo_slug;
    END IF;
  END LOOP;
END;
$$ LANGUAGE plpgsql;

-- Inserir exemplo de landing page
INSERT INTO public.landing_pages (
  slug,
  titulo,
  descricao,
  campos_habilitados,
  mensagem_whatsapp,
  cor_primaria
) VALUES (
  'exemplo',
  'Cadastro de Interesse',
  'Preencha o formul√°rio abaixo para receber mais informa√ß√µes',
  '["nome", "telefone", "email", "cidade"]',
  'Ol√° {nome}! Recebemos seu cadastro e entraremos em contato em breve. üöÄ',
  '#3B82F6'
) ON CONFLICT (slug) DO NOTHING;

-- Verificar dados
SELECT 
  id,
  slug,
  titulo,
  ativo,
  total_acessos,
  total_conversoes,
  created_at
FROM public.landing_pages
ORDER BY created_at DESC;
